# Item 6: Avoid creating unnecessary objects

避免建立不必要的物件，特別是在迴圈中或頻繁呼叫的方法裡。不可變物件 (immutable object) 通常可以重複使用。

## 基本原則

### ❌ 避免不必要的物件建立

```java
// 錯誤：每次都建立新的 String 物件
String s = new String("bikini");

// 錯誤：每次呼叫都建立新的 Boolean 物件
Boolean b = new Boolean("true");
```

### ✅ 重複使用現有物件

```java
// 正確：重複使用 string literal
String s = "bikini";

// 正確：使用 static factory method
Boolean b = Boolean.valueOf("true");
```

## 常見問題與解決方案

### 1. 重複建立昂貴的物件

**問題：Pattern 物件重複建立**

```java
// 效能差：每次都編譯正規表達式
static boolean isRomanNumeral(String s) {
    return s.matches("^(?=.)M*(C[MD]|D?C{0,3})"
            + "(X[CL]|L?X{0,3})(I[XV]|V?I{0,3})$");
}
```

**解決：快取昂貴物件**

```java
public class RomanNumerals {
    private static final Pattern ROMAN = Pattern.compile(
            "^(?=.)M*(C[MD]|D?C{0,3})"
            + "(X[CL]|L?X{0,3})(I[XV]|V?I{0,3})$");

    static boolean isRomanNumeral(String s) {
        return ROMAN.matcher(s).matches();
    }
}
```

!!! tip "效能提升"
    改進後的版本效能提升約 6.5 倍（從 1.1μs 降到 0.17μs）

### 2. Autoboxing 陷阱

**問題：意外的 autoboxing**

```java
// 極慢！每次迴圈都建立新的 Long 物件
private static long sum() {
    Long sum = 0L;  // 注意這裡是 Long，不是 long
    for (long i = 0; i <= Integer.MAX_VALUE; i++)
        sum += i;   // 每次都 autoboxing！
    return sum;
}
```

**解決：使用基本型別**

```java
private static long sum() {
    long sum = 0L;  // 使用 long 而非 Long
    for (long i = 0; i <= Integer.MAX_VALUE; i++)
        sum += i;
    return sum;
}
```

!!! tip "效能提升"
    修正後執行時間從 6.3 秒縮短到 0.59 秒，提升超過 10 倍

## 最佳實務

### 優先使用基本型別

- ✅ `int`, `long`, `boolean` 等基本型別
- ❌ `Integer`, `Long`, `Boolean` 等包裝類別

### 小心 Autoboxing

- 在迴圈中特別注意基本型別與包裝類別的混用
- 效能敏感的程式碼避免意外的 boxing/unboxing

### 重複使用昂貴物件

- 將昂貴的物件 (如 Pattern) 宣告為 static final
- 使用 static factory methods 而非 constructors
- 考慮使用 object pool (但通常不建議)

## 注意事項

!!! warning "不要過度優化"
    - 現代 JVM 已經高度優化，小物件的建立通常很便宜
    - 不要為了避免物件建立而讓程式碼變得複雜
    - 專注於明顯的效能瓶頸，如昂貴物件和 autoboxing

!!! info "何時不需要擔心"
    - 小且便宜的物件 (如 String, ArrayList)
    - 不在熱點路徑上的程式碼
    - 物件建立能提高程式清晰度的情況

**核心原則：優先考慮程式碼清晰度，在明確的效能問題時才優化物件建立。**
