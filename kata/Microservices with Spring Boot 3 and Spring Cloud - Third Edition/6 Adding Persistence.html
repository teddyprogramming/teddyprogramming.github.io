
<!doctype html>
<html lang="zh-TW" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>6 Adding Persistence - Teddy 的筆記本</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/style.css">
    
      <link rel="stylesheet" href="../../assets/mkdocs_puml/puml.css">
    
      <link rel="stylesheet" href="../../termynal.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#product-service" class="md-skip">
          跳轉到
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="頁首">
    <a href="../.." title="Teddy 的筆記本" class="md-header__button md-logo" aria-label="Teddy 的筆記本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Teddy 的筆記本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              6 Adding Persistence
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜尋" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="搜尋">
        
        <button type="reset" class="md-search__icon md-icon" title="清除" aria-label="清除" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="導覽列" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Teddy 的筆記本" class="md-nav__button md-logo" aria-label="Teddy 的筆記本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Teddy 的筆記本
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_1" >
        
          
          <label class="md-nav__link" for="__nav_1_1" id="__nav_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    JetBrains
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_1">
            <span class="md-nav__icon md-icon"></span>
            JetBrains
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/jet-brains/shortcuts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快捷鍵
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/jet-brains/postfix-completion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Postfix Completion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Vim
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            Vim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vim/zsh.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zsh
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vim/vscode.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vim/ideavim.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IdeaVim
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vim/neovim.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    neovim
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/vim/advanced.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/terminal.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Terminal
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    DevOps
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DevOps
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Terraform
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Terraform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/backend.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/import_infrastructure.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Import Infrastructure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/intro_to_terraform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro to Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/style_guide.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Style Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devops/terraform/workspaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workspaces
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/apply.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Apply
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../kubernetes/pod-topology-spread-constraints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pod Topology Spread Constraints
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Domain-Driven Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Domain-Driven Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/01-crunching-knowledge.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 Crunching Knowledge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/02-communication-and-the-use-of-language.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Communication and the Use of Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/03-binding-model-and-implementation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 Binding Model and Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/04-isolating-the-domain.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Isolating the Domain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/05-a-model-expressed-in-software.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 A Model Expressed in Software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/06-the-life-cycle-of-a-domain-object.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 The Life Cycle of a Domain Object
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/07-using-the-language-an-extended-example.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7 Using the Language - An Extended Example
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/08-breakthrough.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8 Breakthrough
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/09-making-implicit-concepts-explicit.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9 Making Implicit Concepts Explicit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../domain-driven-design/10-supple-design.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 Supple Design
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Clean Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Clean Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clean-architecture/34.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    34 The Missing Chapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Effective Java, 3rd
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Effective Java, 3rd
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1_1" id="__nav_5_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Creating And Destroying Objects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_1">
            <span class="md-nav__icon md-icon"></span>
            Creating And Destroying Objects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/001.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 1 - Consider static factory methods instead of constructors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/002.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 2 - Consider a builder when faced with many constructor parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/003.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 3 - Enforce the singleton property with a private constructor or an enum type
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/004.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 4 - Enforce noninstantiability with a private constructor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/005.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 5 - Prefer dependency injection to hardwiring resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/006.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 6 - Avoid creating unnecessary objects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/007.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 7 - Eliminate obsolete object references
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/008.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 8 - Avoid finalizers and cleaners
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/009.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 9 - Prefer try-with-resources to try-finally
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_2" >
        
          
          <label class="md-nav__link" for="__nav_5_1_2" id="__nav_5_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Methods Common To All Objects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_2">
            <span class="md-nav__icon md-icon"></span>
            Methods Common To All Objects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/010.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 10 - Obey the general contract when overriding equals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/011.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 11 - Always override hashCode when you override equals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/012.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 12 = Always override toString
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/013.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 13 - Override clone judiciously
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/014.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 14 - Consider implementing Comparable
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_3" >
        
          
          <label class="md-nav__link" for="__nav_5_1_3" id="__nav_5_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Classes and Interface
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_3">
            <span class="md-nav__icon md-icon"></span>
            Classes and Interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/015.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 15 - Minimize the accessibility of classes and members
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/016.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 16 - In public classes, use accessor methods, not public fields
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_4" >
        
          
          <label class="md-nav__link" for="__nav_5_1_4" id="__nav_5_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Methods
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_4">
            <span class="md-nav__icon md-icon"></span>
            Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../java/effective-java/055.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 55 - Return optionals judiciously
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python/pyenv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pyenv
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Spring Boot
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Spring Boot
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scheduler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Scheduler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_1" id="__nav_7_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Quartz
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1">
            <span class="md-nav__icon md-icon"></span>
            Quartz
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spring-boot/scheduler/hello_world.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hello World!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spring-boot/scheduler/jdbc_job_store.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JDBC JobStore
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spring-boot/testing/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Microservices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Microservices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../spring-boot/microservices-with-spring-boot-3-and-spring-cloud/03-creating-a-set-of-cooperating-microservices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 Creating a Set of Cooperating Microservices
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../feature-toggles/main.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Feature Toggles
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Kata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microservices with Spring Boot 3 and Spring Cloud
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../blog/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>6 Adding Persistence</h1>

<p><code>product</code> 和 <code>recommendation</code> 使用 MongoDB，<code>review</code> 使用 MySQL。</p>
<div class='puml-container'><div class="puml light" style=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="DESCRIPTION" height="281px" preserveAspectRatio="xMidYMid meet" style="width:431px;height:281px;background:#FFFFFF;" version="1.1" viewBox="0 0 431 281" width="431px" zoomAndPan="magnify" class="diagram"><defs/><g><g class="entity" data-entity="pc" data-source-line="2" data-uid="ent0002" id="entity_pc"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="172.877" x="131.42" y="7"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="284.297" y="12"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="282.297" y="14"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="282.297" y="18"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="132.877" x="146.42" y="39.9951">Product Composite</text></g><g class="entity" data-entity="p" data-source-line="3" data-uid="ent0003" id="entity_p"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="93.71" x="7" y="113.3"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="80.71" y="118.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="78.71" y="120.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="78.71" y="124.3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53.71" x="22" y="146.2951">Product</text></g><g class="entity" data-entity="rd" data-source-line="4" data-uid="ent0004" id="entity_rd"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="163.6484" x="136.03" y="113.3"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="279.6784" y="118.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="277.6784" y="120.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="277.6784" y="124.3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123.6484" x="151.03" y="146.2951">Recommendation</text></g><g class="entity" data-entity="r" data-source-line="5" data-uid="ent0005" id="entity_r"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="90.5791" x="334.57" y="113.3"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="405.1491" y="118.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="403.1491" y="120.3"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="403.1491" y="124.3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.5791" x="349.57" y="146.2951">Review</text></g><g class="entity" data-entity="pm" data-source-line="6" data-uid="ent0006" id="entity_pm"><path d="M10.18,229.59 C10.18,219.59 53.8572,219.59 53.8572,219.59 C53.8572,219.59 97.5345,219.59 97.5345,229.59 L97.5345,254.8869 C97.5345,264.8869 53.8572,264.8869 53.8572,264.8869 C53.8572,264.8869 10.18,264.8869 10.18,254.8869 L10.18,229.59" fill="#F1F1F1" style="stroke:#181818;stroke-width:0.5;"/><path d="M10.18,229.59 C10.18,239.59 53.8572,239.59 53.8572,239.59 C53.8572,239.59 97.5345,239.59 97.5345,229.59" fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.3545" x="20.18" y="256.5851">MongoDB</text></g><g class="entity" data-entity="rdm" data-source-line="7" data-uid="ent0007" id="entity_rdm"><path d="M174.18,229.59 C174.18,219.59 217.8572,219.59 217.8572,219.59 C217.8572,219.59 261.5345,219.59 261.5345,229.59 L261.5345,254.8869 C261.5345,264.8869 217.8572,264.8869 217.8572,264.8869 C217.8572,264.8869 174.18,264.8869 174.18,254.8869 L174.18,229.59" fill="#F1F1F1" style="stroke:#181818;stroke-width:0.5;"/><path d="M174.18,229.59 C174.18,239.59 217.8572,239.59 217.8572,239.59 C217.8572,239.59 261.5345,239.59 261.5345,229.59" fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.3545" x="184.18" y="256.5851">MongoDB</text></g><g class="entity" data-entity="rm" data-source-line="8" data-uid="ent0008" id="entity_rm"><path d="M345.82,229.59 C345.82,219.59 379.8552,219.59 379.8552,219.59 C379.8552,219.59 413.8903,219.59 413.8903,229.59 L413.8903,254.8869 C413.8903,264.8869 379.8552,264.8869 379.8552,264.8869 C379.8552,264.8869 345.82,264.8869 345.82,254.8869 L345.82,229.59" fill="#F1F1F1" style="stroke:#181818;stroke-width:0.5;"/><path d="M345.82,229.59 C345.82,239.59 379.8552,239.59 379.8552,239.59 C379.8552,239.59 413.8903,239.59 413.8903,229.59" fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48.0703" x="355.82" y="256.5851">MySQL</text></g><g class="link" data-entity-1="pc" data-entity-2="p" data-source-line="10" data-uid="lnk9" id="link_pc_p"><path d="M182.27,53.78 C154.76,71.27 121.9231,92.1605 94.4331,109.6405" fill="none" id="pc-to-p" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="89.37,112.86,99.111,111.4062,93.5893,110.1771,94.8183,104.6554,89.37,112.86" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="pc" data-entity-2="rd" data-source-line="11" data-uid="lnk10" id="link_pc_rd"><path d="M217.85,53.78 C217.85,71.27 217.85,89.38 217.85,106.86" fill="none" id="pc-to-rd" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="217.85,112.86,221.85,103.86,217.85,107.86,213.85,103.86,217.85,112.86" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="pc" data-entity-2="r" data-source-line="12" data-uid="lnk11" id="link_pc_r"><path d="M253.01,53.78 C280.18,71.27 312.5752,92.132 339.7252,109.612" fill="none" id="pc-to-r" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="344.77,112.86,339.3681,104.6247,340.566,110.1533,335.0374,111.3512,344.77,112.86" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="p" data-entity-2="pm" data-source-line="13" data-uid="lnk12" id="link_p_pm"><path d="M53.85,159.97 C53.85,177.5 53.85,195.69 53.85,213.12" fill="none" id="p-to-pm" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="53.85,219.12,57.85,210.12,53.85,214.12,49.85,210.12,53.85,219.12" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="rd" data-entity-2="rdm" data-source-line="14" data-uid="lnk13" id="link_rd_rdm"><path d="M217.85,159.97 C217.85,177.5 217.85,195.69 217.85,213.12" fill="none" id="rd-to-rdm" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="217.85,219.12,221.85,210.12,217.85,214.12,213.85,210.12,217.85,219.12" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="r" data-entity-2="rm" data-source-line="15" data-uid="lnk14" id="link_r_rm"><path d="M379.85,159.97 C379.85,177.5 379.85,195.69 379.85,213.12" fill="none" id="r-to-rm" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="379.85,219.12,383.85,210.12,379.85,214.12,375.85,210.12,379.85,219.12" style="stroke:#181818;stroke-width:1;"/></g></g></svg></div><div class="puml dark" style="">520. 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origin Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        h1 {
            color: #5ca731;
            text-align: left;
            margin-left: 20px;
        }
        .error-info {
            text-align: left;
            margin-left: 20px;
        }
        .error-info p:first-child {
            margin-bottom: 75px;
        }
        footer {
            position: absolute;
            bottom: 10px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Origin Unreachable</h1>
    <div class="error-info">
        <p>Sorry, we are unable to reach the origin server at the moment. Please try again later.</p>
        <p><strong>Error ID</strong>: fcb3deab-c914-4a49-b792-b6686b867d04</p>
        <p><strong>Timestamp</strong>: 2025-06-11 11:22:55</p>
        
    </div>
    <footer>Powered by Ezoic</footer>
</body>
</html>
</div></div>

<div class='puml-container'><div class="puml light" style=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="CLASS" height="256px" preserveAspectRatio="xMidYMid meet" style="width:1187px;height:256px;background:#FFFFFF;" version="1.1" viewBox="0 0 1187 256" width="1187px" zoomAndPan="magnify" class="diagram"><defs/><g><g class="entity" data-entity="ProductCompositeService" data-source-line="4" data-uid="ent0002" id="entity_ProductCompositeService"><rect fill="#F1F1F1" height="91.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="397.9229" x="324.64" y="7"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180.168" x="433.5174" y="24.9951">ProductCompositeService</text><line style="stroke:#181818;stroke-width:0.5;" x1="325.64" x2="721.5629" y1="33.2969" y2="33.2969"/><line style="stroke:#181818;stroke-width:0.5;" x1="325.64" x2="721.5629" y1="41.2969" y2="41.2969"/><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="385.9229" x="330.64" y="58.292">createProduct(body: CreateProductCompositeRequest)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318.6162" x="330.64" y="74.5889">getProduct(productId: Int): ProductAggregate</text><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203.3281" x="330.64" y="90.8857">deleteProduct(productId: int)</text></g><g class="entity" data-entity="ProductService" data-source-line="10" data-uid="ent0003" id="entity_ProductService"><rect fill="#F1F1F1" height="91.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="323.2061" x="7" y="158.18"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="105.4512" x="115.8774" y="176.1751">ProductService</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="329.2061" y1="184.4769" y2="184.4769"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="329.2061" y1="192.4769" y2="192.4769"/><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="311.2061" x="13" y="209.472">createProduct(body: CreateProductRequest)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245.0889" x="13" y="225.7689">getProduct(productId: int): Product</text><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203.3281" x="13" y="242.0657">deleteProduct(productId: int)</text></g><g class="entity" data-entity="ReviewService" data-source-line="16" data-uid="ent0004" id="entity_ReviewService"><rect fill="#F1F1F1" height="91.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="316.9443" x="365.13" y="158.18"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="102.3203" x="472.442" y="176.1751">ReviewService</text><line style="stroke:#181818;stroke-width:0.5;" x1="366.13" x2="681.0743" y1="184.4769" y2="184.4769"/><line style="stroke:#181818;stroke-width:0.5;" x1="366.13" x2="681.0743" y1="192.4769" y2="192.4769"/><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="304.9443" x="371.13" y="209.472">createReview(body: CreateReviewRequest)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="294.0547" x="371.13" y="225.7689">getReviews(productId: int): List&lt;Review&gt;</text><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="207.4912" x="371.13" y="242.0657">deleteReviews(productId: int)</text></g><g class="entity" data-entity="RecommendationService" data-source-line="22" data-uid="ent0005" id="entity_RecommendationService"><rect fill="#F1F1F1" height="91.1875" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="463.083" x="717.06" y="158.18"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="175.3896" x="860.9067" y="176.1751">RecommendationService</text><line style="stroke:#181818;stroke-width:0.5;" x1="718.06" x2="1179.143" y1="184.4769" y2="184.4769"/><line style="stroke:#181818;stroke-width:0.5;" x1="718.06" x2="1179.143" y1="192.4769" y2="192.4769"/><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="451.083" x="723.06" y="209.472">createRecommendation(body: CreateRecommendationRequest)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="440.1934" x="723.06" y="225.7689">getRecommendations(productId: int): List&lt;Recommendation&gt;</text><text fill="#FF0000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="280.5605" x="723.06" y="242.0657">deleteRecommendations(productId: int)</text></g><g class="link" data-entity-1="ProductCompositeService" data-entity-2="ProductService" data-source-line="28" data-uid="lnk6" id="link_ProductCompositeService_ProductService"><path codeLine="28" d="M416.61,98.55 C372,117.3 325.8315,136.7056 281.2115,155.4556" fill="none" id="ProductCompositeService-to-ProductService" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="275.68,157.78,285.5268,157.981,280.2896,155.843,282.4276,150.6057,275.68,157.78" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="ProductCompositeService" data-entity-2="ReviewService" data-source-line="29" data-uid="lnk7" id="link_ProductCompositeService_ReviewService"><path codeLine="29" d="M523.6,98.35 C523.6,117.15 523.6,132.97 523.6,151.79" fill="none" id="ProductCompositeService-to-ReviewService" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="523.6,157.79,527.6,148.79,523.6,152.79,519.6,148.79,523.6,157.79" style="stroke:#181818;stroke-width:1;"/></g><g class="link" data-entity-1="ProductCompositeService" data-entity-2="RecommendationService" data-source-line="30" data-uid="lnk8" id="link_ProductCompositeService_RecommendationService"><path codeLine="30" d="M651.98,98.65 C705.25,117.35 761.2686,137.023 814.5486,155.723" fill="none" id="ProductCompositeService-to-RecommendationService" style="stroke:#181818;stroke-width:1;"/><polygon fill="#181818" points="820.21,157.71,813.0425,150.9552,815.4921,156.0541,810.3932,158.5037,820.21,157.71" style="stroke:#181818;stroke-width:1;"/></g></g></svg></div><div class="puml dark" style="">520. 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origin Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        h1 {
            color: #5ca731;
            text-align: left;
            margin-left: 20px;
        }
        .error-info {
            text-align: left;
            margin-left: 20px;
        }
        .error-info p:first-child {
            margin-bottom: 75px;
        }
        footer {
            position: absolute;
            bottom: 10px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Origin Unreachable</h1>
    <div class="error-info">
        <p>Sorry, we are unable to reach the origin server at the moment. Please try again later.</p>
        <p><strong>Error ID</strong>: 492d8892-dae3-44b1-82c0-d457662ddbfd</p>
        <p><strong>Timestamp</strong>: 2025-06-11 11:22:55</p>
        
    </div>
    <footer>Powered by Ezoic</footer>
</body>
</html>
</div></div>

<ul>
<li><code>ProductService</code><ul>
<li>新增 (<code>productId</code> unique)</li>
<li>查詢</li>
<li>刪除</li>
</ul>
</li>
<li><code>ReviewService</code><ul>
<li>新增 (<code>productId</code> + <code>reviewId</code> unique)</li>
<li>查詢</li>
<li>刪除</li>
</ul>
</li>
<li><code>Recommendation</code><ul>
<li>新增 (<code>productId</code> + <code>recommendationId</code> unique)</li>
<li>查詢</li>
<li>刪除</li>
</ul>
</li>
</ul>
<h2 id="product-service">Product Service</h2>
<h3 id="product">功能: 新增 Product</h3>
<h4 id="reopsitory-product">測試: Reopsitory 新增 Product</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@DataMongoTest</span>
<span class="nd">@Import</span><span class="p">(</span><span class="n">MongoDbConfiguration</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@TestMethodOrder</span><span class="p">(</span><span class="n">OrderAnnotation</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">ProductRepositoryTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">productRepository</span><span class="p">:</span><span class="w"> </span><span class="n">ProductRepository</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Order</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">`add product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">ProductEntity</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span>
<span class="w">        </span><span class="n">productRepository</span><span class="p">.</span><span class="na">existsById</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">id</span><span class="o">!!</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>新增 String Data MongoDB 相依</p>
<details class="tip">
<summary>Tip</summary>
<p>在 build.gradle.kts 的 dependencies 區塊中 <span class="keys"><kbd class="key-command">Cmd</kbd><span>+</span><kbd class="key-n">N</kbd></span> &gt; Add Starters... &gt; String Data MongoDB &gt; 勾選 &gt; OK &gt; <span class="keys"><kbd class="key-command">Cmd</kbd><span>+</span><kbd class="key-i">I</kbd></span></p>
</details>
</li>
<li>
<p>新增 String testcontainers 相依</p>
<details class="tip">
<summary>Tip</summary>
<p>在 build.gradle.kts 的 dependencies 區塊中 <span class="keys"><kbd class="key-command">Cmd</kbd><span>+</span><kbd class="key-n">N</kbd></span> &gt; Add Starters... &gt; Testcontainers &gt; 勾選 &gt; OK &gt; <span class="keys"><kbd class="key-command">Cmd</kbd><span>+</span><kbd class="key-i">I</kbd></span></p>
</details>
</li>
<li>
<p>實作 <code>MongoDbConfiguration</code></p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">MongoDbConfiguration.kt</span><pre><span></span><code><span class="nd">@TestConfiguration</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MongoDbConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="nd">@ServiceConnection</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">container</span><span class="p">():</span><span class="w"> </span><span class="n">MongoDBContainer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">MongoDBContainer</span><span class="p">(</span><span class="s">&quot;mongo:6.0.4&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
<li>
<p>實作 <code>ProductRepository</code>, <code>ProductEntity</code></p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">ProductRepository.kt</span><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">ProductRepository</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MongoRepository</span><span class="o">&lt;</span><span class="n">ProductEntity</span><span class="p">,</span><span class="w"> </span><span class="kt">String</span><span class="o">&gt;</span>
</code></pre></div>
<div class="highlight"><span class="filename">ProductEntity.kt</span><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.Id</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.data.annotation.Version</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.data.mongodb.core.mapping.Document</span>

<span class="nd">@Document</span><span class="p">(</span><span class="s">&quot;product&quot;</span><span class="p">)</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ProductEntity</span><span class="p">(</span>
<span class="w">    </span><span class="nd">@Id</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="nd">@Version</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">version</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">    </span><span class="nd">@Indexed</span><span class="p">(</span><span class="n">unique</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">name</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">weight</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><span class="filename">application.properties</span><pre><span></span><code><span class="na">spring.data.mongodb.auto-index-creation</span><span class="o">=</span><span class="s">true</span>
</code></pre></div>
</details>
<h4 id="repository-product">測試: Repository 新增重複的 Product</h4>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`add duplicate product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">shouldThrow</span><span class="o">&lt;</span><span class="n">DuplicateKeyException</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">productRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">ProductEntity</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="mapper-createproductrequest-productentity">測試: Mapper 將 CreateProductrequest 轉換成 ProductEntity</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@SpringBootTest</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">ProductMapperTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">productMapper</span><span class="p">:</span><span class="w"> </span><span class="n">ProductMapper</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">toEntity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">productMapper</span><span class="p">.</span><span class="na">toEntity</span><span class="p">(</span><span class="n">CreateProductRequest</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">version</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">0</span>
<span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">productId</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">1</span>
<span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span>
<span class="w">            </span><span class="nb">it</span><span class="p">.</span><span class="na">weight</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>新增 mapstruct dependencies</p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">build.gradle.kts</span><pre><span></span><code>plugins {
    kotlin(&quot;kapt&quot;) version &quot;1.9.25&quot;
}

dependencies {
    implementation(&quot;org.mapstruct:mapstruct:1.6.3&quot;)
    kapt(&quot;org.mapstruct:mapstruct-processor:1.6.3&quot;)
}

kapt {
    arguments {
        arg(&quot;mapstruct.defaultComponentModel&quot;, &quot;spring&quot;)
    }
}
</code></pre></div>
</details>
</li>
<li>
<p>實作 Mapper</p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">ProductMapper.kt</span><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">org.example.productservice.persistence.ProductEntity</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.mapstruct.Mapper</span>

<span class="nd">@Mapper</span>
<span class="kd">interface</span><span class="w"> </span><span class="nc">ProductMapper</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">toEntity</span><span class="p">(</span><span class="n">createProductRequest</span><span class="p">:</span><span class="w"> </span><span class="n">CreateProductRequest</span><span class="p">):</span><span class="w"> </span><span class="n">ProductEntity</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
</ul>
<h4 id="mapper-productentity-product">測試: Mapper 將 ProductEntity 轉換成 Product</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">toProduct</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">productMapper</span><span class="p">.</span><span class="na">toProduct</span><span class="p">(</span><span class="n">ProductEntity</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">productId</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">weight</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>實作 toProduct</p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><pre><span></span><code><span class="nd">@Mappings</span><span class="p">(</span>
<span class="w">    </span><span class="n">Mapping</span><span class="p">(</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;serviceAddress&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">constant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">toProduct</span><span class="p">(</span><span class="n">productEntity</span><span class="p">:</span><span class="w"> </span><span class="n">ProductEntity</span><span class="p">):</span><span class="w"> </span><span class="n">Product</span>
</code></pre></div>
</details>
</li>
</ul>
<h4 id="api-product">測試: API 實作新增 Product</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@SpringBootTest</span><span class="p">(</span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">)</span>
<span class="nd">@TestMethodOrder</span><span class="p">(</span><span class="n">OrderAnnotation</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@Import</span><span class="p">(</span><span class="n">MongoDbConfiguration</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">ProductServiceImplApplicationTests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Order</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">`create product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/product&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span><span class="n">CreateProductRequest</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.productId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.name&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;product-1&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.weight&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p>這裡 <code>@Order</code> 給 2，後面會需要在前面測試不存在的 case</p>
</li>
<li>
<p>在 <code>ProductService</code> 新增 <code>createProduct</code> 方法</p>
</li>
<li>如果需要，調整 <code>CreateProductRequest</code> 所放的 module</li>
<li>在 <code>ProductServiceImpl</code> 中實作 <code>createProduct</code> 的 API</li>
<li>
<p>搭配 <code>ProductMapper</code>, <code>ProductRepository</code> 實作 <code>createProduct</code></p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">ProductServiceImpl.kt</span><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/product&quot;</span><span class="p">)</span>
<span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createProduct</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="n">CreateProductRequest</span><span class="p">):</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">productRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">toEntity</span><span class="p">()).</span><span class="na">toProduct</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">CreateProductRequest</span><span class="p">.</span><span class="nf">toEntity</span><span class="p">():</span><span class="w"> </span><span class="n">ProductEntity</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">toEntity</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">ProductEntity</span><span class="p">.</span><span class="nf">toProduct</span><span class="p">():</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">productMapper</span><span class="p">.</span><span class="na">toProduct</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="na">copy</span><span class="p">(</span><span class="n">serviceAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serviceUtil</span><span class="p">.</span><span class="na">getServiceAddress</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
</ol>
<h4 id="api-product-id">測試: API 實作新增重複 Product ID</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`duplicate error`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/product&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span><span class="n">CreateProductRequest</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNPROCESSABLE_ENTITY</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.path&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;/product&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.message&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Duplicate key, Product Id: 1&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>捕捉 <code>DuplicateKeyException</code> 拋出 <code>InvalidInputException</code></li>
</ul>
<h3 id="product_1">功能: 查詢 Product</h3>
<h4 id="repository-product-by-productid">測試: Repository 查詢 Product by productId</h4>
<div class="highlight"><span class="filename">ProdcutRepository.kt</span><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`get product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">productRepository</span><span class="p">.</span><span class="na">findByProductId</span><span class="p">(</span><span class="n">savedEntity</span><span class="p">.</span><span class="na">productId</span><span class="p">).</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">productId</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="s">&quot;product-1&quot;</span>
<span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">weight</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>在 <code>ProductRepository</code> 新增 <code>findByProductId</code> 的方法</li>
</ul>
<h4 id="api-product_1">測試: API 實作查詢 Product</h4>
<div class="highlight"><span class="filename">ProductServiceImplApplicationTests.kt</span><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nc">ProductServiceImplApplicationTests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Order</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1">// (1)!</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">`get product not exist`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/product/1&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isNotFound</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.path&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;/product/1&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.message&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Product with productId=1 not found&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// (2)!</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">`get product by productId`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>在新增 Product 前，測試 Product 不存在</li>
<li>原本查詢的測試，放在新增 Product 後執行</li>
</ol>
<!-- 避免下面受上面的影響，將下面的條列式內容被當作程式碼的註解，所以這裡做一個隔開的作用 -->

<ul>
<li>調整 <code>getProduct</code> 的實作</li>
<li>
<p>刪除 <code>productId == 13</code> 回傳找不到 Product 的判斷。</p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">ProductServiceImpl.kt</span><pre><span></span><code><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/product/{productId}&quot;</span><span class="p">)</span>
<span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getProduct</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="w"> </span><span class="n">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">):</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidInputException</span><span class="p">(</span><span class="s">&quot;Invalid productId: </span><span class="si">$</span><span class="n">productId</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">productRepository</span><span class="p">.</span><span class="na">findByProductId</span><span class="p">(</span><span class="n">productId</span><span class="p">).</span><span class="na">orElseThrow</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">NotFoundException</span><span class="p">(</span><span class="s">&quot;Product with productId=</span><span class="si">$</span><span class="n">productId</span><span class="s"> not found&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">    </span><span class="p">}.</span><span class="na">toProduct</span><span class="p">()</span>
</span><span class="p">}</span>
</code></pre></div>
</details>
</li>
</ul>
<h3 id="product_2">功能: 刪除 Product</h3>
<h4 id="repository-product_1">測試: Repository 刪除 Product</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`delete product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">productRepository</span><span class="p">.</span><span class="na">deleteByProductId</span><span class="p">(</span><span class="n">savedEntity</span><span class="p">.</span><span class="na">productId</span><span class="p">)</span>
<span class="w">    </span><span class="n">productRepository</span><span class="p">.</span><span class="na">existsById</span><span class="p">(</span><span class="n">savedEntity</span><span class="p">.</span><span class="na">id</span><span class="o">!!</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="api-product_2">測試: API 刪除 Product</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`delete product`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/product/1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`deleted product is not exist`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/product/1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isNotFound</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="recommendation-service">Recommendation Service</h2>
<div class='puml-container'><div class="puml light" style="">520. 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origin Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        h1 {
            color: #5ca731;
            text-align: left;
            margin-left: 20px;
        }
        .error-info {
            text-align: left;
            margin-left: 20px;
        }
        .error-info p:first-child {
            margin-bottom: 75px;
        }
        footer {
            position: absolute;
            bottom: 10px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Origin Unreachable</h1>
    <div class="error-info">
        <p>Sorry, we are unable to reach the origin server at the moment. Please try again later.</p>
        <p><strong>Error ID</strong>: ec6e820f-0cd6-4732-b4eb-99a26e6174f1</p>
        <p><strong>Timestamp</strong>: 2025-06-11 11:22:55</p>
        
    </div>
    <footer>Powered by Ezoic</footer>
</body>
</html>
</div><div class="puml dark" style="">520. 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origin Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        h1 {
            color: #5ca731;
            text-align: left;
            margin-left: 20px;
        }
        .error-info {
            text-align: left;
            margin-left: 20px;
        }
        .error-info p:first-child {
            margin-bottom: 75px;
        }
        footer {
            position: absolute;
            bottom: 10px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Origin Unreachable</h1>
    <div class="error-info">
        <p>Sorry, we are unable to reach the origin server at the moment. Please try again later.</p>
        <p><strong>Error ID</strong>: 4e414910-28ba-469b-9e41-a93cbf7389ae</p>
        <p><strong>Timestamp</strong>: 2025-06-11 11:22:55</p>
        
    </div>
    <footer>Powered by Ezoic</footer>
</body>
</html>
</div></div>

<h3 id="recommendation">測試: 新增 Recommendation</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@SpringBootTest</span><span class="p">(</span><span class="n">webEnvironment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SpringBootTest</span><span class="p">.</span><span class="na">WebEnvironment</span><span class="p">.</span><span class="na">RANDOM_PORT</span><span class="p">)</span>
<span class="nd">@TestMethodOrder</span><span class="p">(</span><span class="n">OrderAnnotation</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@Import</span><span class="p">(</span><span class="n">MongoDbConfiguration</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">RecommendationServiceImplApplicationTests</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="nd">@Order</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">`create recommendations`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">createRecommendationAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Andy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;recommendation 1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">createRecommendationAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;recommendation 2&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">createRecommendationAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Cindy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;recommendation 3&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">createRecommendationAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;recommendation 4&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createRecommendationAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">recommendationId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/recommendation&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span>
<span class="w">                </span><span class="n">RecommendationService</span><span class="p">.</span><span class="na">CreateRecommendationRequest</span><span class="p">(</span>
<span class="w">                    </span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productId</span><span class="p">,</span>
<span class="w">                    </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recommendationId</span><span class="p">,</span>
<span class="w">                    </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">author</span><span class="p">,</span>
<span class="w">                    </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rate</span><span class="p">,</span>
<span class="w">                    </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.productId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">productId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.recommendationId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">recommendationId</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.author&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">author</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.rate&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.content&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>將 <code>MongoDbConfiguration</code> 提取到 <code>util</code> 供不同 module 共用。</p>
<details class="tip">
<summary>Tip</summary>
<p>調整 <code>util</code> 的 build.gradle.kts</p>
<div class="highlight"><span class="filename">build.gradle.kts</span><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">`java-test-fixtures`</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;plugin.spring&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.9.25&quot;</span>
<span class="p">}</span>

<span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">testFixturesImplementation</span><span class="p">(</span><span class="s">&quot;org.testcontainers:junit-jupiter&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">testFixturesImplementation</span><span class="p">(</span><span class="s">&quot;org.springframework.boot:spring-boot-testcontainers&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">testFixturesImplementation</span><span class="p">(</span><span class="s">&quot;org.testcontainers:mongodb&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">testFixturesImplementation</span><span class="p">(</span><span class="s">&quot;org.springframework.boot:spring-boot-starter-test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>將 <code>MongoDbConfiguration</code> 移動到 util 的 src/testFixtures/kotlin 下 (<a href="https://docs.gradle.org/current/userguide/java_testing.html">參考</a>)</p>
<p><code>product-service</code>, <code>recommendation-service</code> 的 build.gradle.kts 增加 util text fixture 的 dependencies</p>
<div class="highlight"><span class="filename">build.gradle.kts</span><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">testImplementation</span><span class="p">(</span><span class="n">testFixtures</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:util&quot;</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
</ul>
<h3 id="recommendation_1">測試: 新增前查詢 Recommendation</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`no recommendation`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/recommendation?productId=1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.length()&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="recommendation_2">測試: 新增後查詢 Recommendation</h3>
<p>在原有的查詢測試增加 <code>@Order(4)</code></p>
<div class="highlight"><pre><span></span><code><span class="nd">@Order</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
</code></pre></div>
<h3 id="recommendation_3">測試: 新增重複的 recommendation 應被拒絕</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`duplicate recommendation should be reject`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/recommendation&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span>
<span class="w">            </span><span class="n">RecommendationService</span><span class="p">.</span><span class="na">CreateRecommendationRequest</span><span class="p">(</span>
<span class="w">                </span><span class="n">productId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">recommendationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Andy&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span>
<span class="w">                </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;recommendation 1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNPROCESSABLE_ENTITY</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.path&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;/recommendation&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.message&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Duplicate key, ProductId: 1, RecommendationId: 1&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="recommendation_4">測試: 刪除 recommendation</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`delete recommendation`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">recommendationRepository</span><span class="p">.</span><span class="na">existsByProductId</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/recommendation?productId=1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">    </span><span class="n">recommendationRepository</span><span class="p">.</span><span class="na">existsByProductId</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="n">shouldBe</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="review-service">Review Service</h2>
<div class='puml-container'><div class="puml light" style=""><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="MINDMAP" height="336px" preserveAspectRatio="xMidYMid meet" style="width:829px;height:336px;background:#FFFFFF;" version="1.1" viewBox="0 0 829 336" width="829px" zoomAndPan="magnify" class="diagram"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="121.2061" x="10" y="149.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101.2061" x="20" y="172.1279">review service</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="99.0575" x="181.2061" y="74.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79.0575" x="191.2061" y="97.1826">新增 review</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="34.0703" x="333.2635" y="97.1826">Test</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.3154" x="367.3339" y="97.1826">: API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51.7412" x="451.6493" y="60.5889">Service</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="33.4277" x="556.3905" y="60.5889">Data</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.1699" x="642.8182" y="23.9951">productId</text><path d="M589.8182,55.7422 L599.8182,55.7422 C614.8182,55.7422 614.8182,19.1484 629.8182,19.1484 L639.8182,19.1484" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59.623" x="642.8182" y="42.292">reviewId</text><path d="M589.8182,55.7422 L599.8182,55.7422 C614.8182,55.7422 614.8182,37.4453 629.8182,37.4453 L639.8182,37.4453" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46.1357" x="642.8182" y="60.5889">author</text><path d="M589.8182,55.7422 L599.8182,55.7422 C614.8182,55.7422 614.8182,55.7422 629.8182,55.7422 L639.8182,55.7422" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50.7432" x="642.8182" y="78.8857">subject</text><path d="M589.8182,55.7422 L599.8182,55.7422 C614.8182,55.7422 614.8182,74.0391 629.8182,74.0391 L639.8182,74.0391" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53.6006" x="642.8182" y="97.1826">content</text><path d="M589.8182,55.7422 L599.8182,55.7422 C614.8182,55.7422 614.8182,92.3359 629.8182,92.3359 L639.8182,92.3359" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M503.3905,55.7422 L513.3905,55.7422 C528.3905,55.7422 528.3905,55.7422 543.3905,55.7422 L553.3905,55.7422" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M398.6493,92.3359 L408.6493,92.3359 C423.6493,92.3359 423.6493,55.7422 438.6493,55.7422 L448.6493,55.7422" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75.0723" x="451.6493" y="124.6279">Repository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="48.0703" x="579.7216" y="115.4795">MySQL</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="136.9717" x="680.7919" y="115.4795">MySqlConfiguration</text><path d="M627.7919,110.6328 L637.7919,110.6328 C652.7919,110.6328 652.7919,110.6328 667.7919,110.6328 L677.7919,110.6328" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M526.7216,119.7813 L536.7216,119.7813 C551.7216,119.7813 551.7216,110.6328 566.7216,110.6328 L576.7216,110.6328" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40.8721" x="579.7216" y="133.7764">Entity</text><path d="M526.7216,119.7813 L536.7216,119.7813 C551.7216,119.7813 551.7216,128.9297 566.7216,128.9297 L576.7216,128.9297" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M398.6493,92.3359 L408.6493,92.3359 C423.6493,92.3359 423.6493,119.7813 438.6493,119.7813 L448.6493,119.7813" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52.8008" x="451.6493" y="161.2217">Mapper</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54.9268" x="557.4501" y="152.0732">toEntity</text><path d="M504.4501,156.375 L514.4501,156.375 C529.4501,156.375 529.4501,147.2266 544.4501,147.2266 L554.4501,147.2266" fill="none" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64.6338" x="557.4501" y="170.3701">toReview</text><path d="M504.4501,156.375 L514.4501,156.375 C529.4501,156.375 529.4501,165.5234 544.4501,165.5234 L554.4501,165.5234" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M398.6493,92.3359 L408.6493,92.3359 C423.6493,92.3359 423.6493,156.375 438.6493,156.375 L448.6493,156.375" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M280.2635,92.3359 L290.2635,92.3359 C305.2635,92.3359 305.2635,92.3359 320.2635,92.3359 L330.2635,92.3359" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M131.2061,167.2813 L141.2061,167.2813 C156.2061,167.2813 156.2061,92.3359 171.2061,92.3359 L181.2061,92.3359" fill="none" style="stroke:#181818;stroke-width:1;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="99.0575" x="181.2061" y="165.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79.0575" x="191.2061" y="188.667">查詢 review</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="34.0703" x="333.2635" y="188.667">Test</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.3154" x="367.3339" y="188.667">: API</text><path d="M280.2635,183.8203 L290.2635,183.8203 C305.2635,183.8203 305.2635,183.8203 320.2635,183.8203 L330.2635,183.8203" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M131.2061,167.2813 L141.2061,167.2813 C156.2061,167.2813 156.2061,183.8203 171.2061,183.8203 L181.2061,183.8203" fill="none" style="stroke:#181818;stroke-width:1;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="201.5073" x="181.2061" y="221.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="181.5073" x="191.2061" y="244.9639">新增重複的 review 應被拒絕</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="34.0703" x="435.7133" y="244.9639">Test</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.3154" x="469.7836" y="244.9639">: API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="199.8828" x="554.0991" y="244.9639">productId + reviewId unique</text><path d="M501.0991,240.1172 L511.0991,240.1172 C526.0991,240.1172 526.0991,240.1172 541.0991,240.1172 L551.0991,240.1172" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M382.7133,240.1172 L392.7133,240.1172 C407.7133,240.1172 407.7133,240.1172 422.7133,240.1172 L432.7133,240.1172" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M131.2061,167.2813 L141.2061,167.2813 C156.2061,167.2813 156.2061,240.1172 171.2061,240.1172 L181.2061,240.1172" fill="none" style="stroke:#181818;stroke-width:1;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="99.0575" x="181.2061" y="278.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79.0575" x="191.2061" y="301.2607">刪除 review</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="34.0703" x="333.2635" y="301.2607">Test</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31.3154" x="367.3339" y="301.2607">: API</text><path d="M280.2635,296.4141 L290.2635,296.4141 C305.2635,296.4141 305.2635,296.4141 320.2635,296.4141 L330.2635,296.4141" fill="none" style="stroke:#181818;stroke-width:1;"/><path d="M131.2061,167.2813 L141.2061,167.2813 C156.2061,167.2813 156.2061,296.4141 171.2061,296.4141 L181.2061,296.4141" fill="none" style="stroke:#181818;stroke-width:1;"/></g></svg></div><div class="puml dark" style="">520. 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Origin Error</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            position: relative;
        }
        h1 {
            color: #5ca731;
            text-align: left;
            margin-left: 20px;
        }
        .error-info {
            text-align: left;
            margin-left: 20px;
        }
        .error-info p:first-child {
            margin-bottom: 75px;
        }
        footer {
            position: absolute;
            bottom: 10px;
            color: #777;
        }
    </style>
</head>
<body>
    <h1>Origin Unreachable</h1>
    <div class="error-info">
        <p>Sorry, we are unable to reach the origin server at the moment. Please try again later.</p>
        <p><strong>Error ID</strong>: 0a58bdcd-c068-4835-8337-12dafb619166</p>
        <p><strong>Timestamp</strong>: 2025-06-11 11:22:55</p>
        
    </div>
    <footer>Powered by Ezoic</footer>
</body>
</html>
</div></div>

<h3 id="review">測試: 新增 review</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`create review`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">createReviewAndCheck</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Andy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subject 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;content 1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">createReviewAndCheck</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subject 2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;content 2&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">createReviewAndCheck</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Cindy&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;subject 3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;content 3&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createReviewAndCheck</span><span class="p">(</span><span class="n">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">reviewId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">author</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">subject</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;&quot;&quot;{</span>
<span class="s">                    &quot;productId&quot;: </span><span class="si">$</span><span class="n">productId</span><span class="s">,</span>
<span class="s">                    &quot;reviewId&quot;: </span><span class="si">$</span><span class="n">reviewId</span><span class="s">,</span>
<span class="s">                    &quot;author&quot;: &quot;</span><span class="si">$</span><span class="n">author</span><span class="s">&quot;,</span>
<span class="s">                    &quot;subject&quot;: &quot;</span><span class="si">$</span><span class="n">subject</span><span class="s">&quot;,</span>
<span class="s">                    &quot;content&quot;: &quot;</span><span class="si">$</span><span class="n">content</span><span class="s">&quot;</span>
<span class="s">                }&quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.productId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">productId</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.reviewId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">reviewId</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.subject&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.content&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>
<p>Repository</p>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><span class="filename">ReviewRepository.kt</span><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Entity</span>
<span class="k">import</span><span class="w"> </span><span class="nn">jakarta.persistence.GeneratedValue</span>
<span class="k">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Id</span>
<span class="k">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Table</span>
<span class="k">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Version</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.data.repository.CrudRepository</span>

<span class="kd">interface</span><span class="w"> </span><span class="nc">ReviewRepository</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">ReviewRepository</span><span class="p">.</span><span class="na">ReviewEntity</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Entity</span>
<span class="w">    </span><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ReviewEntity</span><span class="p">(</span>
<span class="w">        </span><span class="nd">@Id</span>
<span class="w">        </span><span class="nd">@GeneratedValue</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">Int?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">        </span><span class="nd">@Version</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">version</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">reviewId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">author</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">subject</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">content</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">application.perperties</span><pre><span></span><code><span class="na">spring.jpa.hibernate.ddl-auto</span><span class="o">=</span><span class="s">update</span>
</code></pre></div>
<div class="highlight"><span class="filename">build.gradle.kts</span><pre><span></span><code><span class="n">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;kapt&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.9.25&quot;</span>
<span class="w">    </span><span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;plugin.jpa&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s">&quot;1.9.25&quot;</span>
<span class="p">}</span>

<span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;org.springframework.boot:spring-boot-starter-data-jpa&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">runtimeOnly</span><span class="p">(</span><span class="s">&quot;com.mysql:mysql-connector-j&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">testImplementation</span><span class="p">(</span><span class="n">testFixtures</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:util&quot;</span><span class="p">)))</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
<li>
<p>Test container configuration</p>
<details class="tip">
<summary>Tip</summary>
<p>設定在 util</p>
<div class="highlight"><span class="filename">build.gradle.kts</span><pre><span></span><code><span class="n">dependencies</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">testFixturesImplementation</span><span class="p">(</span><span class="s">&quot;org.testcontainers:mysql&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><span class="filename">MySqlConfiguration.kt</span><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.boot.test.context.TestConfiguration</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.boot.testcontainers.service.connection.ServiceConnection</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.springframework.context.annotation.Bean</span>
<span class="k">import</span><span class="w"> </span><span class="nn">org.testcontainers.containers.MySQLContainer</span>

<span class="nd">@TestConfiguration</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MySqlConfiguration</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="nd">@ServiceConnection</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">mysqlContainer</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MySQLContainer</span><span class="p">(</span><span class="s">&quot;mysql:8.0.36&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</details>
</li>
</ul>
<h3 id="review_1">測試: 查詢 review</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`no reviews`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review?productId=1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.length()&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`get review by productId`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review?productId=1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.length()&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">[0].productId&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="review_2">測試: 新增重複的 review 應被拒絕</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`reject if review is duplicate`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">post</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">bodyValue</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;&quot;&quot;{</span>
<span class="s">                    &quot;productId&quot;: </span><span class="si">${</span><span class="m">1</span><span class="si">}</span><span class="s">,</span>
<span class="s">                    &quot;reviewId&quot;: </span><span class="si">${</span><span class="m">1</span><span class="si">}</span><span class="s">,</span>
<span class="s">                    &quot;author&quot;: &quot;</span><span class="si">${</span><span class="s">&quot;</span><span class="n">Andy</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;,</span>
<span class="s">                    &quot;subject&quot;: &quot;</span><span class="si">${</span><span class="s">&quot;</span><span class="n">subject</span><span class="w"> </span><span class="m">1</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;,</span>
<span class="s">                    &quot;content&quot;: &quot;</span><span class="si">${</span><span class="s">&quot;</span><span class="n">content</span><span class="w"> </span><span class="m">1</span><span class="s">&quot;</span><span class="si">}</span><span class="s">&quot;</span>
<span class="s">                }&quot;&quot;&quot;</span><span class="p">.</span><span class="na">trimIndent</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNPROCESSABLE_ENTITY</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.path&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;/review&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.message&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="s">&quot;Duplicate key, Product Id: 1, Review Id: 1&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><pre><span></span><code><span class="nd">@Table</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">indexes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">Index</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;reviews_unique_idx&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">columnList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;productId, reviewId&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unique</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="o">]</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/review&quot;</span><span class="p">)</span>
<span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createReview</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="n">CreateReviewRequest</span><span class="p">):</span><span class="w"> </span><span class="n">Review</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">DataIntegrityViolationException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="o">?.</span><span class="na">lowercase</span><span class="p">()</span><span class="o">?.</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;duplicate entry&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">InvalidInputException</span><span class="p">(</span><span class="s">&quot;Duplicate key, Product Id: </span><span class="si">${</span><span class="n">request</span><span class="p">.</span><span class="na">productId</span><span class="si">}</span><span class="s">, Review Id: </span><span class="si">${</span><span class="n">request</span><span class="p">.</span><span class="na">reviewId</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h3 id="review_3">測試: 刪除 review</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`delete review`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review?productId=1&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="nd">@Order</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="c1">// 既有的測試，增加 @Order annotation</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">`get review not found`</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">uri</span><span class="p">(</span><span class="s">&quot;/review?productId=1&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 將查詢的 productId 改成 1</span>
<span class="w">        </span><span class="p">.</span><span class="na">accept</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">exchange</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectStatus</span><span class="p">().</span><span class="na">isOk</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectHeader</span><span class="p">().</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">expectBody</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">jsonPath</span><span class="p">(</span><span class="s">&quot;</span><span class="err">$</span><span class="s">.length()&quot;</span><span class="p">).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<details class="tip">
<summary>Tip</summary>
<div class="highlight"><pre><span></span><code><span class="kd">interface</span><span class="w"> </span><span class="nc">ReviewRepository</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">ReviewRepository</span><span class="p">.</span><span class="na">ReviewEntity</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="nd">@Transactional</span><span class="w"> </span><span class="c1">// 加 annotation</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">deleteByProductId</span><span class="p">(</span><span class="n">productId</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</details>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最後更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年3月27日 17:33:28 UTC">2025年3月27日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="建立日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年2月14日 02:47:45 UTC">2025年2月14日</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到頂端
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024-2025 Teddy Lee
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.select", "content.code.annotate", "content.code.copy", "toc.integrate", "navigation.top", "content.footnote.tooltips", "content.tooltips"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../assets/mkdocs_puml/puml.js"></script>
      
        <script src="../../termynal.js"></script>
      
    
  </body>
</html>