
<!doctype html>
<html lang="zh-TW" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="07-srp.html">
      
      
        <link rel="next" href="34.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>22 Clean Architecture - Teddy 的筆記本</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/style.css">
    
      <link rel="stylesheet" href="../termynal.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#clean-architecture" class="md-skip">
          跳轉到
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="頁首">
    <a href=".." title="Teddy 的筆記本" class="md-header__button md-logo" aria-label="Teddy 的筆記本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Teddy 的筆記本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              22 Clean Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜尋" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="搜尋">
        
        <button type="reset" class="md-search__icon md-icon" title="清除" aria-label="清除" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="導覽列" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Teddy 的筆記本" class="md-nav__button md-logo" aria-label="Teddy 的筆記本" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Teddy 的筆記本
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_1" >
        
          
          <label class="md-nav__link" for="__nav_1_1" id="__nav_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    JetBrains
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_1">
            <span class="md-nav__icon md-icon"></span>
            JetBrains
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/jet-brains/shortcuts.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    快捷鍵
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/jet-brains/postfix-completion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Postfix Completion
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" >
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Vim
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            Vim
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/vim/zsh.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    zsh
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/vim/vscode.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VSCode
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/vim/ideavim.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IdeaVim
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/vim/neovim.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    neovim
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/vim/advanced.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/terminal.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Terminal
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    DevOps
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DevOps
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Terraform
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Terraform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/backend.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Backend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/import_infrastructure.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Import Infrastructure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/intro_to_terraform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro to Terraform
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/state.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    State
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/style_guide.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Style Guide
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops/terraform/workspaces.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workspaces
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kubernetes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Kubernetes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/apply.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Apply
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes/pod-topology-spread-constraints.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pod Topology Spread Constraints
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Domain-Driven Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Domain-Driven Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/01-crunching-knowledge.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1 Crunching Knowledge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/02-communication-and-the-use-of-language.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2 Communication and the Use of Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/03-binding-model-and-implementation.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3 Binding Model and Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/04-isolating-the-domain.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4 Isolating the Domain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/05-a-model-expressed-in-software.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    5 A Model Expressed in Software
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/06-the-life-cycle-of-a-domain-object.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    6 The Life Cycle of a Domain Object
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/07-using-the-language-an-extended-example.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    7 Using the Language - An Extended Example
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/08-breakthrough.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    8 Breakthrough
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/09-making-implicit-concepts-explicit.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    9 Making Implicit Concepts Explicit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../domain-driven-design/10-supple-design.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    10 Supple Design
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Clean Architecture
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Clean Architecture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="07-srp.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    07 Single Responsibility Principle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    22 Clean Architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="22-clean-architecture.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    22 Clean Architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Problem">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      具體挑戰
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forces" class="md-nav__link">
    <span class="md-ellipsis">
      Forces
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Forces">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      穩定性需求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      可測試性需求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      可維護性需求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      可替換性需求
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dependency-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Dependency Rule (依賴規則)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      四個同心圓分層
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四個同心圓分層">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-entities-" class="md-nav__link">
    <span class="md-ellipsis">
      1. Entities (實體層) - 企業業務規則
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-use-cases-" class="md-nav__link">
    <span class="md-ellipsis">
      2. Use Cases (使用案例層) - 應用業務規則
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-interface-adapters-adapter" class="md-nav__link">
    <span class="md-ellipsis">
      3. Interface Adapters (介面 Adapter 層)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-frameworks-drivers" class="md-nav__link">
    <span class="md-ellipsis">
      4. Frameworks &amp; Drivers (框架和驅動程式層)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      依賴注入和介面
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#controller-presenter" class="md-nav__link">
    <span class="md-ellipsis">
      Controller 和 Presenter 的依賴反轉
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Controller 和 Presenter 的依賴反轉">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#controller-dip-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Controller 透過 DIP 呼叫 Use Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#presenter-dip-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Presenter 透過 DIP 接收 Use Cases 結果
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      關鍵特點
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#results" class="md-nav__link">
    <span class="md-ellipsis">
      Results
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Results">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      正面效果
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      潛在缺點
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="34.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    34 The Missing Chapter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Effective Java, 3rd
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Effective Java, 3rd
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1_1" id="__nav_5_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Creating And Destroying Objects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_1">
            <span class="md-nav__icon md-icon"></span>
            Creating And Destroying Objects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/001.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 1 - Consider static factory methods instead of constructors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/002.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 2 - Consider a builder when faced with many constructor parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/003.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 3 - Enforce the singleton property with a private constructor or an enum type
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/004.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 4 - Enforce noninstantiability with a private constructor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/005.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 5 - Prefer dependency injection to hardwiring resources
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/006.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 6 - Avoid creating unnecessary objects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/007.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 7 - Eliminate obsolete object references
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/008.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 8 - Avoid finalizers and cleaners
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/009.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 9 - Prefer try-with-resources to try-finally
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_2" >
        
          
          <label class="md-nav__link" for="__nav_5_1_2" id="__nav_5_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Methods Common To All Objects
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_2">
            <span class="md-nav__icon md-icon"></span>
            Methods Common To All Objects
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/010.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 10 - Obey the general contract when overriding equals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/011.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 11 - Always override hashCode when you override equals
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/012.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 12 = Always override toString
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/013.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 13 - Override clone judiciously
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/014.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 14 - Consider implementing Comparable
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_3" >
        
          
          <label class="md-nav__link" for="__nav_5_1_3" id="__nav_5_1_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Classes and Interface
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_3">
            <span class="md-nav__icon md-icon"></span>
            Classes and Interface
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/015.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 15 - Minimize the accessibility of classes and members
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/016.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 16 - In public classes, use accessor methods, not public fields
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1_4" >
        
          
          <label class="md-nav__link" for="__nav_5_1_4" id="__nav_5_1_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Methods
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_5_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1_4">
            <span class="md-nav__icon md-icon"></span>
            Methods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java/effective-java/055.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Item 55 - Return optionals judiciously
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/pyenv.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    pyenv
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Spring Boot
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Spring Boot
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scheduler
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Scheduler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1_1" id="__nav_7_1_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Quartz
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1_1">
            <span class="md-nav__icon md-icon"></span>
            Quartz
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spring-boot/scheduler/hello_world.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hello World!
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spring-boot/scheduler/jdbc_job_store.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JDBC JobStore
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spring-boot/testing/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Microservices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Microservices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spring-boot/microservices-with-spring-boot-3-and-spring-cloud/03-creating-a-set-of-cooperating-microservices.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    03 Creating a Set of Cooperating Microservices
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../feature-toggles/main.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Feature Toggles
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Kata
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Kata
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../kata/Microservices%20with%20Spring%20Boot%203%20and%20Spring%20Cloud%20-%20Third%20Edition/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Microservices with Spring Boot 3 and Spring Cloud
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../blog/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="clean-architecture">Clean Architecture</h1>
<h2 id="context">Context</h2>
<p>在現代軟體開發中，應用程式通常需要整合多個外部系統: 資料庫、Web框架、第三方服務、UI框架等。這些外部依賴經常變化，而核心業務邏輯相對穩定。在傳統分層架構中，業務邏輯層往往直接依賴具體的技術實作 (如特定的資料庫存取類別、外部服務客戶端)，而不是依賴抽象介面。這種直接依賴會導致業務邏輯與技術細節緊密耦合，使系統難以測試、難以維護，且容易受到外部變化的影響。</p>
<h2 id="problem">Problem</h2>
<p><strong>如何設計一個既能整合必要外部系統，又能保護核心業務邏輯不受外部變化影響的架構？</strong></p>
<h3 id="_1">具體挑戰</h3>
<ol>
<li>
<p><strong>外部依賴的不穩定性</strong></p>
<ul>
<li>資料庫技術可能從關聯式改為 NoSQL</li>
<li>Web 框架版本升級可能破壞 API</li>
<li>第三方服務可能更改介面或停止服務</li>
</ul>
</li>
<li>
<p><strong>測試困難</strong></p>
<ul>
<li>單元測試需要真實資料庫連線</li>
<li>整合測試需要外部服務正常運作</li>
<li>測試環境設置複雜且脆弱</li>
</ul>
</li>
<li>
<p><strong>業務邏輯散落</strong></p>
<ul>
<li>
<p>業務規則分散在資料存取層中</p>
<div class="highlight"><pre><span></span><code><span class="c1">// DAO 層包含業務邏輯</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderDAO</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 業務規則混在 DAO 中</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getTotal</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">order</span><span class="p">.</span><span class="na">setStatus</span><span class="p">(</span><span class="s">&quot;REQUIRES_APPROVAL&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">jdbcTemplate</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="s">&quot;INSERT INTO orders...&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>用戶介面包含業務決策邏輯</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Controller 包含業務邏輯</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">createOrder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getOrderFromForm</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 業務規則混在 UI 層</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">customerType</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;VIP&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">order</span><span class="p">.</span><span class="nx">total</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">order</span><span class="p">.</span><span class="nx">discount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">saveOrder</span><span class="p">(</span><span class="nx">order</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>很難找到「業務邏輯在哪裡」</p>
<ul>
<li>折扣計算在前端</li>
<li>訂單驗證在 DAO</li>
<li>狀態判斷在 Service</li>
<li>相同邏輯重複出現在多個地方</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="forces">Forces</h2>
<h3 id="_2">穩定性需求</h3>
<ul>
<li>業務邏輯是系統的核心價值，應該最穩定</li>
<li>外部技術細節變化頻繁，不應影響核心邏輯</li>
</ul>
<h3 id="_3">可測試性需求</h3>
<ul>
<li>業務邏輯必須能夠獨立測試</li>
<li>不應依賴外部系統來驗證核心邏輯</li>
</ul>
<h3 id="_4">可維護性需求</h3>
<ul>
<li>修改外部整合不應影響業務邏輯<ul>
<li>例如: 從 MySQL 改為 PostgreSQL，不需要修改訂單計算邏輯</li>
</ul>
</li>
<li>業務邏輯變更不應影響技術實作細節<ul>
<li>例如: 修改折扣計算規則，不需要修改資料庫 schema 或 API 格式</li>
<li><strong>前提</strong>: 初始設計時的抽象分層要適當<ul>
<li>資料庫 schema 設計要足夠通用 (如: discount_amount 而非 vip_discount)</li>
<li>API 介面要足夠彈性 (如: 使用通用的計算結果欄位)</li>
<li>領域模型要穩定且表達力強</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="_5">可替換性需求</h3>
<ul>
<li>應該能夠替換資料庫而不修改業務邏輯</li>
<li>應該能夠替換 UI 框架而不修改業務邏輯</li>
</ul>
<h2 id="solution">Solution</h2>
<p>Clean Architecture 透過 <strong>依賴反轉</strong> 和 <strong>明確分層</strong> 來解決這些問題:</p>
<h3 id="dependency-rule">Dependency Rule (依賴規則)</h3>
<p><strong><span style="color: #0099FF;">Source code</span><sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> dependencies must point only inward, toward higher-level policies. (<span style="color: #0099FF;">程式碼</span>依賴必須只指向內層，朝向更高層級的政策。)</strong></p>
<div class="admonition note">
<p class="admonition-title">什麼是「政策」(Policy)？</p>
<p>在軟體架構中，「政策」指的是系統的核心業務邏輯和規則，例如:</p>
<ul>
<li>業務規則: 「訂單金額超過 10000 元需要主管核准」</li>
<li>計算邏輯: 「VIP 客戶享有 10% 折扣」</li>
<li>工作流程: 「訂單建立 → 庫存檢查 → 付款處理 → 出貨」</li>
</ul>
<p>這些政策代表系統的核心價值，相對穩定且不應該依賴於技術實作細節 (如資料庫類型、UI 框架等)。</p>
</div>
<p><img alt="" src="22-1.png" /></p>
<h3 id="_6">四個同心圓分層</h3>
<p>Clean Architecture 將系統分為四個同心圓分層，每層都有明確的職責:</p>
<div class="admonition note">
<p class="admonition-title">關於圓圈數量的說明</p>
<p>Robert Martin 在書中提到：</p>
<ul>
<li><strong>圖中的四個圓圈只是示意圖</strong>：並非固定限制</li>
<li><strong>可以有更多圓圈</strong>：根據應用程式的複雜度，可能需要更多層次</li>
<li><strong>依賴規則仍然適用</strong>：無論有多少層，依賴關係都必須指向內層</li>
</ul>
<p>重點是<strong>依賴方向</strong>和<strong>關注點分離</strong>的原則。</p>
</div>
<p><img alt="Kroki" src="https://kroki.io/plantuml/svg/eNqlU8tuwjAQvPsrLA5VcoAPQBVSC6qaShWor7uxF3AxsWs7UET59zpOCM6rl_oC7M7OeGfMhjPAlGsqACFF6JasAQ_eDeApMWAG-ISwOzy1oFeEurIGYmGuGegkVZldSG1LUH7gG2hmIdLwlYGxz5KBGIdDL0Ej9mNn1C8xz2xbQ2kwkNrXjFIwxkkZJVMDXVpBp0esBCppuJX6GMgYsodI5u1xgYrLzwqx4im7PyYs4qxsJSwHKctlSsStL01CXSqIMeEVndO50ZjvlICd28r85XDJ0jE_zIaT5i7oHESaVBvfMaLc9yrb4k5-dipTq6UQoAMf6FUt2lirygRrTj9e63F7Xw9ZFKnVqP-TZH7WYD84HHw1imsTVb19nSe2pP2xf7ruG7g4HNPYYy-_SqbQ1QdNdnCQemvwDZ5pvm_5GhLUUyz6M2LJMk_wdKVvZjF02Xa9CtQwdjT6mXT_e1Dfk-lGdznkyZsvrAvoeWu-1Tzw7cvW6Bdjan6G?"></p>
<h4 id="1-entities-">1. Entities (實體層) - 企業業務規則</h4>
<ul>
<li><strong>職責</strong>: 封裝企業級業務邏輯和規則</li>
<li><strong>特徵</strong>:<ul>
<li>最不可能因外部變化而改變</li>
<li>可被多個應用程式重用</li>
<li>不依賴任何外層</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 範例: 訂單實體</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Order</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderId</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CustomerId</span><span class="w"> </span><span class="n">customerId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">OrderStatus</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 業務規則: 訂單總額計算</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Money</span><span class="w"> </span><span class="nf">calculateTotal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">OrderItem</span><span class="p">::</span><span class="n">getSubtotal</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">reduce</span><span class="p">(</span><span class="n">Money</span><span class="p">.</span><span class="na">ZERO</span><span class="p">,</span><span class="w"> </span><span class="n">Money</span><span class="p">::</span><span class="n">add</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 業務規則: 訂單確認條件</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">confirm</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">items</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Cannot confirm empty order&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Order already processed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderStatus</span><span class="p">.</span><span class="na">CONFIRMED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="2-use-cases-">2. Use Cases (使用案例層) - 應用業務規則</h4>
<ul>
<li><strong>職責</strong>: 協調實體的互動以完成特定應用功能</li>
<li><strong>特徵</strong>:<ul>
<li>包含應用特定的業務規則</li>
<li>定義資料進出的介面</li>
<li>不關心資料如何呈現或持久化</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// Use Cases 層定義的 Repository 介面</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OrderRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Order</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">);</span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findById</span><span class="p">(</span><span class="n">OrderId</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 範例: 建立訂單使用案例</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreateOrderUseCase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreateOrderOutputPort</span><span class="w"> </span><span class="n">outputPort</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CreateOrderUseCase</span><span class="p">(</span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">,</span>
<span class="w">                              </span><span class="n">CreateOrderOutputPort</span><span class="w"> </span><span class="n">outputPort</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">orderRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">outputPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputPort</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">CreateOrderRequestModel</span><span class="w"> </span><span class="n">requestModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 建立訂單實體</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Order</span><span class="p">(</span>
<span class="w">            </span><span class="n">OrderId</span><span class="p">.</span><span class="na">generate</span><span class="p">(),</span>
<span class="w">            </span><span class="n">requestModel</span><span class="p">.</span><span class="na">getCustomerId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">buildOrderItems</span><span class="p">(</span><span class="n">requestModel</span><span class="p">.</span><span class="na">getItems</span><span class="p">())</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 應用業務規則</span>
<span class="w">        </span><span class="n">order</span><span class="p">.</span><span class="na">confirm</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 持久化</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">savedOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 透過 OutputPort 回傳結果</span>
<span class="w">        </span><span class="n">CreateOrderResponseModel</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderResponseModel</span><span class="p">(</span>
<span class="w">            </span><span class="n">savedOrder</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getValue</span><span class="p">(),</span>
<span class="w">            </span><span class="n">savedOrder</span><span class="p">.</span><span class="na">calculateTotal</span><span class="p">().</span><span class="na">getValue</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">outputPort</span><span class="p">.</span><span class="na">presentSuccess</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItem</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">buildOrderItems</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItemData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 建構 OrderItem 的邏輯</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">(),</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="3-interface-adapters-adapter">3. Interface Adapters (介面 Adapter 層)</h4>
<ul>
<li><strong>職責</strong>: 在內外層之間轉換資料格式，讓不同的介面能夠溝通</li>
<li><strong>包含</strong>:<ul>
<li>Controllers</li>
<li>Gateways</li>
<li>Presenters</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 範例: 訂單控制器</span>
<span class="nd">@RestController</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">createOrderInputPort</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">OrderController</span><span class="p">(</span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">createOrderInputPort</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">createOrderInputPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createOrderInputPort</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/orders&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">createOrder</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">CreateOrderHttpRequest</span><span class="w"> </span><span class="n">httpRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 將 HTTP 請求模型轉換為 Use Case 請求模型</span>
<span class="w">        </span><span class="n">CreateOrderRequestModel</span><span class="w"> </span><span class="n">requestModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderRequestModel</span><span class="p">(</span>
<span class="w">            </span><span class="n">httpRequest</span><span class="p">.</span><span class="na">getCustomerId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">httpRequest</span><span class="p">.</span><span class="na">getItems</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 透過 InputPort 執行使用案例</span>
<span class="w">        </span><span class="n">createOrderInputPort</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">requestModel</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 範例: Repository 實作 (屬於 Interface Adapters 層)</span>
<span class="nd">@Repository</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JdbcOrderRepository</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">OrderRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">JdbcTemplate</span><span class="w"> </span><span class="n">jdbcTemplate</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">JdbcOrderRepository</span><span class="p">(</span><span class="n">JdbcTemplate</span><span class="w"> </span><span class="n">jdbcTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">jdbcTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdbcTemplate</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 將領域物件轉換為資料庫格式</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;INSERT INTO orders (id, customer_id, total, status) VALUES (?, ?, ?, ?)&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">jdbcTemplate</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span>
<span class="w">            </span><span class="n">order</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getValue</span><span class="p">(),</span>
<span class="w">            </span><span class="n">order</span><span class="p">.</span><span class="na">getCustomerId</span><span class="p">().</span><span class="na">getValue</span><span class="p">(),</span>
<span class="w">            </span><span class="n">order</span><span class="p">.</span><span class="na">calculateTotal</span><span class="p">().</span><span class="na">getValue</span><span class="p">(),</span>
<span class="w">            </span><span class="n">order</span><span class="p">.</span><span class="na">getStatus</span><span class="p">().</span><span class="na">name</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">order</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findById</span><span class="p">(</span><span class="n">OrderId</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT id, customer_id, total, status FROM orders WHERE id = ?&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jdbcTemplate</span><span class="p">.</span><span class="na">queryForObject</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span>
<span class="w">                </span><span class="p">(</span><span class="n">rs</span><span class="p">,</span><span class="w"> </span><span class="n">rowNum</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OrderMapper</span><span class="p">.</span><span class="na">fromResultSet</span><span class="p">(</span><span class="n">rs</span><span class="p">),</span>
<span class="w">                </span><span class="n">id</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">EmptyResultDataAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Optional</span><span class="p">.</span><span class="na">empty</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="4-frameworks-drivers">4. Frameworks &amp; Drivers (框架和驅動程式層)</h4>
<ul>
<li><strong>職責</strong>: 提供實際的技術基礎設施</li>
<li><strong>包含</strong>:<ul>
<li><strong>Frameworks (框架)</strong>: Spring Boot, Express.js, Django 等</li>
<li><strong>Drivers (驅動程式)</strong>: 資料庫驅動、檔案系統、網路協議等</li>
<li><strong>External Systems (外部系統)</strong>: 第三方 API、訊息佇列、快取系統等</li>
<li><strong>Infrastructure (基礎設施)</strong>: Web Server、Database、File System 等</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 範例: 資料庫配置 (Frameworks &amp; Drivers 層)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DatabaseConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DataSource</span><span class="w"> </span><span class="nf">dataSource</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">HikariDataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HikariDataSource</span><span class="p">();</span>
<span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setJdbcUrl</span><span class="p">(</span><span class="s">&quot;jdbc:postgresql://localhost:5432/orders&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setUsername</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dataSource</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JdbcTemplate</span><span class="w"> </span><span class="nf">jdbcTemplate</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JdbcTemplate</span><span class="p">(</span><span class="n">dataSource</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>重要概念澄清</strong>：<br />
- <strong>Repository 介面</strong>：定義在 Use Cases 層 (內層定義抽象)<br />
- <strong>Repository 實作</strong>：位於 Interface Adapters 層 (外層實作抽象)<br />
- <strong>資料庫驅動/框架</strong>：位於 Frameworks &amp; Drivers 層 (最外層基礎設施)</p>
<h3 id="_7">依賴注入和介面</h3>
<p>透過依賴注入實現依賴反轉:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 在組裝層進行依賴注入</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CreateOrderUseCase</span><span class="w"> </span><span class="nf">createOrderUseCase</span><span class="p">(</span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderUseCase</span><span class="p">(</span><span class="n">orderRepository</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">OrderRepository</span><span class="w"> </span><span class="nf">orderRepository</span><span class="p">(</span><span class="n">JdbcTemplate</span><span class="w"> </span><span class="n">jdbcTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JdbcOrderRepository</span><span class="p">(</span><span class="n">jdbcTemplate</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="controller-presenter">Controller 和 Presenter 的依賴反轉</h3>
<p>Controller 和 Presenter 透過 DIP 與 Use Cases 互動：</p>
<p><strong>依賴方向說明</strong>：</p>
<ul>
<li>
<p><strong>Controller 層 (Interface Adapters)</strong>：</p>
<ul>
<li>Controller 依賴 InputPort interface (向內依賴)</li>
<li>Controller 使用 HttpRequest model (同層依賴)</li>
<li>Controller 建立 RequestModel 傳遞給 Use Case</li>
</ul>
</li>
<li>
<p><strong>Use Case 層</strong>：</p>
<ul>
<li>UseCase 實作 InputPort interface</li>
<li>UseCase 依賴 OutputPort interface (同層依賴)</li>
<li>UseCase 依賴 Repository interface (同層依賴)</li>
<li>使用 Request 和 Response Models 進行資料傳遞</li>
</ul>
</li>
<li>
<p><strong>Interface Adapters 層</strong>：</p>
<ul>
<li>JdbcOrderRepository 實作 OrderRepository interface (外層實作內層介面)</li>
<li>Repository 實作負責將領域物件轉換為資料庫格式</li>
</ul>
</li>
<li>
<p><strong>Frameworks &amp; Drivers 層</strong>：</p>
<ul>
<li>提供 JdbcTemplate、資料庫驅動等基礎設施</li>
<li>Repository 實作會使用這些基礎設施來完成實際的資料存取</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Clean Architecture 中的資料傳遞設計原則</p>
<p>基於 Clean Architecture 的核心原則，在層與層之間傳遞資料時應該遵循以下設計考量：</p>
<p><strong>核心原則</strong>：</p>
<ul>
<li><strong>依賴規則</strong>：內層不應該知道外層的存在</li>
<li><strong>框架獨立性</strong>：業務邏輯不應依賴特定的技術框架</li>
<li><strong>介面隔離</strong>：使用介面定義邊界，而非具體實作</li>
</ul>
<p><strong>實作建議</strong>：</p>
<ul>
<li>Use Cases 透過 Input Port 接收資料</li>
<li>Use Cases 透過 Output Port 傳送資料</li>
<li>資料結構應該是 <strong>不依賴外部框架的純粹資料結構</strong></li>
<li>通常實作為 POJO (Plain Old Java Objects) 或 DTO (Data Transfer Objects)</li>
</ul>
<p><strong>設計考量</strong>：</p>
<ul>
<li><strong>框架獨立性</strong>：避免在核心業務邏輯中使用框架特定的註解或依賴</li>
<li><strong>職責分離</strong>：每層有自己的資料模型，透過轉換來隔離變化</li>
<li><strong>測試性</strong>：純粹的資料結構易於建立和測試</li>
</ul>
<p><strong>對比範例</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// ❌ 包含框架依賴</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreateOrderHttpRequest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">&quot;customer_id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nd">@NotBlank</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">customerId</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Valid</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItemRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ✅ 框架獨立的資料結構</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreateOrderRequestModel</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">customerId</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItemData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 建構子和 getter...</span>
<span class="p">}</span>
</code></pre></div>
<p>這種設計確保 Use Case 層符合 Clean Architecture 的依賴規則。</p>
</div>
<ul>
<li>
<p><strong>Presenter 層</strong>：</p>
<ul>
<li>Presenter 實作 OutputPort interface</li>
<li>Presenter 接收 ResponseModel 並轉換為 ViewModel</li>
<li>ViewModel 包含 UI 特定的展示邏輯</li>
</ul>
</li>
</ul>
<p><strong>關鍵設計原則</strong>：</p>
<ul>
<li>每一層都有自己的資料模型，避免跨層污染</li>
<li>依賴方向始終指向內層(業務核心)</li>
<li>外層負責資料轉換和格式 adaptation</li>
</ul>
<h4 id="controller-dip-use-cases">Controller 透過 DIP 呼叫 Use Cases</h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CreateOrderInputPort</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">CreateOrderRequestModel</span><span class="w"> </span><span class="n">requestModel</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@RestController</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">createOrderUseCase</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">OrderController</span><span class="p">(</span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">createOrderUseCase</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">createOrderUseCase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createOrderUseCase</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">&quot;/orders&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">createOrder</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">CreateOrderHttpRequest</span><span class="w"> </span><span class="n">httpRequest</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 將 HTTP 請求模型轉換為 Use Case 請求模型</span>
<span class="w">        </span><span class="n">CreateOrderRequestModel</span><span class="w"> </span><span class="n">requestModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderRequestModel</span><span class="p">(</span>
<span class="w">            </span><span class="n">httpRequest</span><span class="p">.</span><span class="na">getCustomerId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">convertToOrderItemData</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">.</span><span class="na">getItems</span><span class="p">())</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">createOrderUseCase</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">requestModel</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">().</span><span class="na">build</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItemData</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">convertToOrderItemData</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderItemRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="n">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 轉換邏輯：處理 HTTP 特定的資料格式</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">items</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderItemData</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="na">getProductId</span><span class="p">(),</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">()))</span>
<span class="w">            </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>為什麼 Controller 也需要分別定義 HttpRequest 和 RequestModel？</strong></p>
<ol>
<li>
<p><strong>HTTP 層的職責</strong>：</p>
<ul>
<li><code>CreateOrderHttpRequest</code> 處理 HTTP 特定的需求 (如 JSON 序列化、驗證註解)</li>
<li><code>CreateOrderRequestModel</code> 專注於業務邏輯所需的純淨資料</li>
</ul>
</li>
<li>
<p><strong>框架獨立性與資料轉換控制</strong>：</p>
<ul>
<li>Use Case 不依賴 Spring Boot 或 JSON 等框架的註解和依賴</li>
<li>業務邏輯可以在不同的應用程式類型中重用 (Web API、CLI 工具、批次處理等)</li>
<li>Controller 可以在轉換過程中處理 HTTP 特定的邏輯 (如資料驗證、格式轉換、預設值設定)</li>
</ul>
</li>
</ol>
<p><strong>Controller 使用 DIP 與 Use Case 互動的好處</strong>：</p>
<ol>
<li>
<p><strong>鬆耦合設計</strong></p>
<ul>
<li>Controller 不知道具體的 Use Case 實作細節</li>
<li>可以替換不同的 Use Case 實作而不修改 Controller</li>
</ul>
</li>
<li>
<p><strong>可測試性</strong></p>
<p>Controller 透過 DIP 的主要測試價值在於能夠隔離測試各層的職責：</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">shouldReturn200WhenOrderCreatedSuccessfully</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 模擬成功的 Use Case</span>
<span class="w">    </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">mockUseCase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mockito</span><span class="p">.</span><span class="na">mock</span><span class="p">(</span><span class="n">CreateOrderInputPort</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">OrderController</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderController</span><span class="p">(</span><span class="n">mockUseCase</span><span class="p">);</span>

<span class="w">    </span><span class="n">CreateOrderHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderHttpRequest</span><span class="p">(</span><span class="s">&quot;CUST001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// 測試 HTTP 層的行為</span>
<span class="w">    </span><span class="n">ResponseEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="na">createOrder</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getStatusCode</span><span class="p">()).</span><span class="na">isEqualTo</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Test</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">shouldReturn500WhenUseCaseThrowsException</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 模擬 Use Case 拋出例外</span>
<span class="w">    </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="n">mockUseCase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mockito</span><span class="p">.</span><span class="na">mock</span><span class="p">(</span><span class="n">CreateOrderInputPort</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">doThrow</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Database error&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">when</span><span class="p">(</span><span class="n">mockUseCase</span><span class="p">).</span><span class="na">execute</span><span class="p">(</span><span class="n">any</span><span class="p">());</span>

<span class="w">    </span><span class="n">OrderController</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrderController</span><span class="p">(</span><span class="n">mockUseCase</span><span class="p">);</span>
<span class="w">    </span><span class="n">CreateOrderHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderHttpRequest</span><span class="p">(</span><span class="s">&quot;CUST001&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// 驗證 Controller 如何處理例外</span>
<span class="w">    </span><span class="n">assertThrows</span><span class="p">(</span><span class="n">RuntimeException</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">        </span><span class="n">controller</span><span class="p">.</span><span class="na">createOrder</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>重點是測試 <strong>Controller 的職責</strong>（HTTP 處理、錯誤處理），而非驗證是否有呼叫其他組件。</p>
</li>
<li>
<p><strong>框架獨立性</strong></p>
<ul>
<li>Controller 的核心邏輯不依賴特定的業務實作</li>
<li>可以從 Spring MVC 切換到其他 Web 框架，Use Case 不受影響</li>
</ul>
</li>
<li>
<p><strong>職責分離</strong></p>
<ul>
<li>Controller 專注於 HTTP 請求處理和資料轉換</li>
<li>Use Case 專注於業務邏輯執行</li>
<li>各自可以獨立演化和測試</li>
</ul>
</li>
</ol>
<h4 id="presenter-dip-use-cases">Presenter 透過 DIP 接收 Use Cases 結果</h4>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CreateOrderOutputPort</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">presentSuccess</span><span class="p">(</span><span class="n">CreateOrderResponseModel</span><span class="w"> </span><span class="n">responseModel</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderPresenter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreateOrderOutputPort</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">CreateOrderViewModel</span><span class="w"> </span><span class="n">viewModel</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">presentSuccess</span><span class="p">(</span><span class="n">CreateOrderResponseModel</span><span class="w"> </span><span class="n">responseModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">viewModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderViewModel</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;訂單建立成功&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1">// UI 訊息</span>
<span class="w">            </span><span class="n">responseModel</span><span class="p">.</span><span class="na">getOrderId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">formatCurrency</span><span class="p">(</span><span class="n">responseModel</span><span class="p">.</span><span class="na">getTotal</span><span class="p">())</span><span class="w"> </span><span class="c1">// 格式化顯示</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">formatCurrency</span><span class="p">(</span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NumberFormat</span><span class="p">.</span><span class="na">getCurrencyInstance</span><span class="p">(</span><span class="n">Locale</span><span class="p">.</span><span class="na">TAIWAN</span><span class="p">).</span><span class="na">format</span><span class="p">(</span><span class="n">amount</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CreateOrderViewModel</span><span class="w"> </span><span class="nf">getViewModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">viewModel</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CreateOrderUseCase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CreateOrderInputPort</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">CreateOrderOutputPort</span><span class="w"> </span><span class="n">outputPort</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CreateOrderUseCase</span><span class="p">(</span><span class="n">CreateOrderOutputPort</span><span class="w"> </span><span class="n">outputPort</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">outputPort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">outputPort</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="n">CreateOrderRequestModel</span><span class="w"> </span><span class="n">requestModel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Order</span><span class="p">(</span>
<span class="w">            </span><span class="n">OrderId</span><span class="p">.</span><span class="na">generate</span><span class="p">(),</span>
<span class="w">            </span><span class="n">requestModel</span><span class="p">.</span><span class="na">getCustomerId</span><span class="p">(),</span>
<span class="w">            </span><span class="n">requestModel</span><span class="p">.</span><span class="na">getItems</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="n">order</span><span class="p">.</span><span class="na">confirm</span><span class="p">();</span>

<span class="w">        </span><span class="n">Order</span><span class="w"> </span><span class="n">savedOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orderRepository</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>

<span class="w">        </span><span class="n">CreateOrderResponseModel</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderResponseModel</span><span class="p">(</span>
<span class="w">            </span><span class="n">savedOrder</span><span class="p">.</span><span class="na">getId</span><span class="p">().</span><span class="na">getValue</span><span class="p">(),</span>
<span class="w">            </span><span class="n">savedOrder</span><span class="p">.</span><span class="na">calculateTotal</span><span class="p">().</span><span class="na">getValue</span><span class="p">()</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">outputPort</span><span class="p">.</span><span class="na">presentSuccess</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="_8">關鍵特點</h4>
<ul>
<li><strong>Controller 不直接依賴 Use Case 實作</strong>：透過 InputPort 介面</li>
<li><strong>Use Case 不直接依賴 Presenter 實作</strong>：透過 OutputPort 介面</li>
<li><strong>依賴方向正確</strong>：外層依賴內層的抽象介面</li>
<li><strong>各層職責清晰</strong>：Controller 處理 HTTP，Presenter 處理格式化，Use Case 處理業務邏輯</li>
</ul>
<h2 id="results">Results</h2>
<h3 id="_9">正面效果</h3>
<ol>
<li>
<p><strong>獨立性 (Independence)</strong></p>
<ul>
<li>業務邏輯完全獨立於外部技術</li>
<li>可以單獨測試核心邏輯</li>
<li>外部系統變更不影響業務邏輯</li>
</ul>
</li>
<li>
<p><strong>可測試性 (Testability)</strong></p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">shouldCreateOrderWhenCustomerExistsAndItemsValid</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用模擬 Repository，無需真實資料庫</span>
<span class="w">    </span><span class="n">OrderRepository</span><span class="w"> </span><span class="n">mockRepository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mockito</span><span class="p">.</span><span class="na">mock</span><span class="p">(</span><span class="n">OrderRepository</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">CreateOrderUseCase</span><span class="w"> </span><span class="n">useCase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CreateOrderUseCase</span><span class="p">(</span><span class="n">mockRepository</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 測試業務邏輯</span>
<span class="w">    </span><span class="n">OrderId</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">useCase</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">validRequest</span><span class="p">);</span>

<span class="w">    </span><span class="n">assertThat</span><span class="p">(</span><span class="n">result</span><span class="p">).</span><span class="na">isNotNull</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>
<p><strong>可替換性 (Replaceability)</strong></p>
<ul>
<li>可以替換資料庫 (MySQL → MongoDB) 而不影響業務邏輯</li>
<li>可以替換 Web 框架 (Spring → Vert.x) 而不修改 Use Cases</li>
<li>可以替換 UI (Web → Mobile) 而不改變核心功能</li>
</ul>
</li>
<li>
<p><strong>規模化發展 (Scalability)</strong></p>
<ul>
<li>團隊可以平行開發不同架構層</li>
<li>新功能不會污染現有核心邏輯</li>
<li>複雜度被明確分離和管理</li>
</ul>
</li>
</ol>
<h3 id="_10">潛在缺點</h3>
<ol>
<li>
<p><strong>複雜度增加</strong></p>
<ul>
<li>需要更多的介面和 Adapter</li>
<li>程式碼行數可能增加</li>
<li>學習曲線較陡峭</li>
</ul>
</li>
<li>
<p><strong>過度設計風險</strong></p>
<ul>
<li>簡單專案可能不需要如此複雜的結構</li>
<li>需要根據專案規模衡量是否適用</li>
</ul>
</li>
<li>
<p><strong>團隊學習成本</strong></p>
<ul>
<li>需要團隊對架構有共同理解</li>
<li>需要良好的文件和培訓</li>
</ul>
</li>
</ol>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>這裡特別強調「程式碼」依賴，是因為在最外層基本上是非程式碼 (例如資料庫、檔案系統等)，這些外部系統不受此依賴規則約束。&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最後更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年8月6日 14:39:23 UTC">2025年8月6日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="建立日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年7月26日 18:31:23 UTC">2025年7月26日</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到頂端
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024-2025 Teddy Lee
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.select", "content.code.annotate", "content.code.copy", "toc.integrate", "navigation.top", "content.footnote.tooltips", "content.tooltips"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../termynal.js"></script>
      
    
  </body>
</html>